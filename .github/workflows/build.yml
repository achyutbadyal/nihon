name: Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type to generate"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - foss
          - both

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up JDK
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          java-version: 17
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2

      - name: Get Version
        run: |
          VERSION=$(grep 'versionName =' app/build.gradle.kts | awk -F'"' '{print $2}')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build selected variant(s)
        run: |
          set -e

          case "${{ github.event.inputs.build_type }}" in
            release)
              ./gradlew assembleRelease -Pinclude-telemetry -Penable-updater
              ;;
            foss)
              ./gradlew assembleFoss -Penable-updater
              ;;
            both)
              ./gradlew assembleRelease assembleFoss -Pinclude-telemetry -Penable-updater
              ;;
          esac

      - name: Sign Release APKs
        if: github.event.inputs.build_type != 'foss'
        uses: r0adkll/sign-android-release@f30bdd30588842ac76044ecdbd4b6d0e3e813478
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "35.0.1"

      - name: Sign FOSS APK
        if: github.event.inputs.build_type != 'release'
        uses: r0adkll/sign-android-release@f30bdd30588842ac76044ecdbd4b6d0e3e813478
        with:
          releaseDirectory: app/build/outputs/apk/foss
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "35.0.1"

      - name: Rename APKs
        run: |
          set -e

          if [[ "${{ github.event.inputs.build_type }}" != "foss" ]]; then
            mv app/build/outputs/apk/release/app-universal-release-unsigned-signed.apk kikyo-$VERSION.apk
            mv app/build/outputs/apk/release/app-arm64-v8a-release-unsigned-signed.apk kikyo-arm64-v8a-$VERSION.apk
            mv app/build/outputs/apk/release/app-armeabi-v7a-release-unsigned-signed.apk kikyo-armeabi-v7a-$VERSION.apk
            mv app/build/outputs/apk/release/app-x86-release-unsigned-signed.apk kikyo-x86-$VERSION.apk
            mv app/build/outputs/apk/release/app-x86_64-release-unsigned-signed.apk kikyo-x86_64-$VERSION.apk
          fi

          if [[ "${{ github.event.inputs.build_type }}" != "release" ]]; then
            mv app/build/outputs/apk/foss/app-universal-foss-unsigned-signed.apk kikyo-$VERSION-foss.apk
          fi

      - name: Push APKs to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e

          APP_NAME="Kikyo"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"

          MESSAGE=$(cat <<EOF\nðŸ“¦ *$APP_NAME*\nðŸ”¢ *Version:* $VERSION\nðŸ›  *Build:* ${BUILD_TYPE^^}\n\nâ¬‡ï¸ APKs:\nEOF)

          for apk in kikyo-*.apk; do
            MESSAGE="$MESSAGE\nâ€¢ \`$apk\`"
          done

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d parse_mode=Markdown \
            -d text="$MESSAGE"

          for apk in kikyo-*.apk; do
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -F chat_id="$CHAT_ID" \
              -F document=@"$apk"
          done

      - name: Upload APKs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: kikyo
          path: kikyo-*.apk